<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #questions {
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }

        #results {

            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }

        #score {

            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }

        #questions>button {
            background-color: gray;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin-top: 30px;


        }

        .question {
            display: none;
        }

        .question.active {
            display: block;
        }

        .question>h2 {
            font-size: 40px;
            color: rgb(165, 119, 59);
        }

        .question>p {
            font-size: 20px;
            border: 1px solid black;
            padding: 10px;
            border-radius: 10px;
        }

        .question>button {
            background-color: gray;
            color: white;

            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;

        }

        .options input[type="radio"] {
            margin-right: 10px;
        }

        .options {
            padding: 10px;
        }

        .options-box {
            padding: 10px;
            margin-bottom: 10px;
        }

        .options label {
            font-size: 20px;
            margin: 10px;
        }

        .options input[type="radio"]:checked+label {
            font-weight: bold;
            color: blue;
        }

        #timer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
        }



        #score {
            margin-top: 20px;
            font-weight: bold;
        }

        #kyabhai {
            display: block;
            margin: 0 auto;
            max-width: 300px;
            height: auto;
            padding: 20px;
        }

        #sorrybtn {
            display: block;
            margin: 0 auto;
            padding: 10px 20px;
            background-color: grey;
            color: white;
            font-size: 1.2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #sorrybtn:hover {
            background-color: #c62828;
        }

        #results {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #results>h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        table {
            margin: 0 auto;
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        #print {
            display: block;
            background-color: gray;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin: 10px auto;
        }

        #tac {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #tac>button {
            display: block;
            background-color: gray;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin: 10px auto;
        }

        .list {
            max-width: 800px;
            list-style-type: disc;
            margin-top: 10px;
            padding: 0 0 0 20px;
        }

        .list li {
            margin: 10px 0;
            line-height: 1.5;
            font-size: 16px;
            font-family: Arial, sans-serif;
            color: #333;
        }

        #JumpSelect {
            max-width: 200px;
            margin-top: 20px;
            font-size: 16px;
            padding: 4px 16px;
            border: 2px solid gray;
            border-radius: 5px;
            background-color: white;
            color: black;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="tac">
        <h2>Rules:</h2>
        <ul class="list">
            <li>Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatem laborum eos rem sequi veniam
                necessitatibus aut, tempore est amet assumenda provident velit nostrum officia enim omnis vero aperiam
                ad incidunt.</li>
            <li>Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatem laborum eos rem sequi veniam
                necessitatibus aut, tempore est amet assumenda provident velit nostrum officia enim omnis vero aperiam
                ad incidunt.</li>
            <li>Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatem laborum eos rem sequi veniam
                necessitatibus aut, tempore est amet assumenda provident velit nostrum officia enim omnis vero aperiam
                ad incidunt.</li>
            <li>Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatem laborum eos rem sequi veniam
                necessitatibus aut, tempore est amet assumenda provident velit nostrum officia enim omnis vero aperiam
                ad incidunt.</li>
            <li>Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatem laborum eos rem sequi veniam
                necessitatibus aut, tempore est amet assumenda provident velit nostrum officia enim omnis vero aperiam
                ad incidunt.</li>
        </ul>
        <p id="testlength"></p>
        <button type="button" id="accept_tac">Start Test</button>
    </div>

    <div id="timer">
        <span id="minutes"></span>:<span id="seconds"></span>
    </div>
    <div id="questions"></div>
    <div id="results">
        <h2>Test Result:</h2>
        <hr>
        <br>
        <br>
        <table id="resultTable">
            <thead>
                <tr>
                    <th></th>
                    <th>TotalQuestion</th>
                    <th>Correct</th>
                    <th>Wrong</th>
                    <th>Unattempted</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Verbal</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Genral Awerness</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Aptitude</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Reasoning</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="5"><b>Total</b></td>

                    <td></td>
                </tr>

            </tbody>
        </table>

        <button onclick="printDiv('questions', 'results')" id="print">Print</button>
    </div>

    <script>
        if (!localStorage.getItem('TestLength')) {
            window.location.replace('/')
        }
        let correctAnswers = []
        function printDiv(div1, div2) {
            const questions = document.getElementsByClassName('question');

            for (let i = 0; i < questions.length; i++) {
                questions[i].style.display = 'block';

                const label = questions[i].getElementsByTagName('label')
                for (let j = 0; j < label.length; j++) {

                    if (answers[`question${i + 1}`] == label[j].innerText) {
                        console.log('sjh')
                        if (correctAnswers[i] == answers[`question${i + 1}`]) {

                            label[j].style.border = '2px solid green'
                        } else {
                            label[j].style.border = '2px solid red'

                        }
                        label[j].style.color = 'blue'
                        label[j].style.padding = '10px'
                        label[j].style.borderRadius = '5px'
                    }
                }

                const headingTags = questions[i].getElementsByTagName('h2');
                for (let j = 0; j < headingTags.length; j++) {
                    headingTags[j].style.fontSize = '30px';
                }

                const buttons = questions[i].getElementsByTagName('button');
                for (let j = 0; j < buttons.length; j++) {
                    buttons[j].style.display = 'none';
                }

                const pTags = questions[i].getElementsByTagName('p');
                for (let j = 0; j < pTags.length; j++) {
                    pTags[j].style.border = 'none';
                }

                const ans = document.createElement('p')
                ans.id = 'ans'
                ans.innerHTML = `<b>Correct Answer:</b> ${correctAnswers[i]}`

                questions[i].appendChild(ans)
            }

            const originalContents = document.body.innerHTML;
            const temp = document.createElement('div')
            const printtemp = document.getElementById('print')
            printtemp.style.display = 'none'
            const printContents1 = document.getElementById(div1);
            const printContents2 = document.getElementById(div2);

            const hr = document.createElement('hr')
            const br = document.createElement('br')
            printContents2.appendChild(br)
            printContents2.appendChild(hr)

            temp.appendChild(printContents2)
            temp.appendChild(printContents1)

            document.body.innerHTML = temp.innerHTML;
            window.print();
            document.body.innerHTML = originalContents;

            for (let i = 0; i < questions.length; i++) {
                const lastP = questions[i].lastElementChild;
                if (lastP.tagName === 'P') {
                    questions[i].removeChild(lastP);
                }
                questions[i].style.display = 'none';
            }
        }

        const AnswerSheet = {
            Verbal: {},
            GeneralAwareness: {},
            Aptitude: {},
            Reasoning: {}
        }
        let submited = true
        const timer = document.getElementById('timer')
        timer.style.display = 'none'
        const ResultDiv = document.getElementById('results')
        ResultDiv.style.display = 'none'

        function startCountdown(totalSeconds, minutesSpan, secondsSpan, btn) {
            const countDown = () => {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;

                minutesSpan.textContent = minutes < 10 ? '0' + minutes : minutes;
                secondsSpan.textContent = seconds < 10 ? '0' + seconds : seconds;

                if (--totalSeconds < 0) {
                    clearInterval(counterInterval);
                    btn.click()
                }
            };
            const counterInterval = setInterval(countDown, 1000);
            return counterInterval

        }

        const questionsContainer = document.querySelector('#questions');
        let currentQuestion = 0;
        let TotalQuestion = 0;

        const answers = {};
        function displayResult() {
            const inputs = document.querySelectorAll('input[type="radio"]:checked');
            for (const input of inputs) {
                answers[input.name] = input.value;
            }

            let correctAnswers = 0;
            let Unattempted = 0;
            let Wrong = 0;

            let Verbal = [0, 0, 0]
            let GeneralAwareness = []
            let Aptitude = []
            let Reasoning = []

            // totalquestion, correct, wrong, unattemped, 
            let topicScore = [0, 0, 0, 0]

            let index = 0
            const table = document.getElementById("resultTable");

            for (const Topic in AnswerSheet) {
                index++
                for (const question in AnswerSheet[Topic]) {
                    topicScore[0]++
                    if (AnswerSheet[Topic][question] === answers[question]) {
                        correctAnswers++;
                        topicScore[1]++
                    } else if (answers[question] == undefined) {
                        Unattempted++
                        topicScore[3]++
                    } else {
                        Wrong++
                        topicScore[2]++
                    }
                }

                const row = table.rows[index];

                const __totalquestion = row.cells[1]
                const __Correct = row.cells[2];
                const __Wrong = row.cells[3];
                const __Unattempted = row.cells[4]
                const __Score = row.cells[5];

                __totalquestion.innerHTML = topicScore[0]
                __Correct.innerHTML = topicScore[1]
                __Wrong.innerHTML = topicScore[2]
                __Unattempted.innerHTML = topicScore[3]

                __Score.innerHTML = topicScore[1] * 4;
                topicScore = [0, 0, 0, 0]


            }
            const totalscore_row = table.rows[5]
            const totalscore = totalscore_row.cells[1]
            totalscore.innerHTML = `${(correctAnswers * 4) - (Wrong * 1)} / ${TotalQuestion * 4}`

        }

        const createQuestion = (question, index, TotalQuestion) => {
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question');
            questionDiv.id = `question${index + 1}`;

            const questionTitle = document.createElement('h2');
            questionTitle.textContent = `Question ${index + 1}`;

            const questionText = document.createElement('p');
            questionText.innerHTML = `${question.question.replace(/\n/g, '<br>')}`;
            const optionsContainer = document.createElement('div');
            optionsContainer.classList.add("options")
            question.options.forEach((option) => {

                const box = document.createElement('div')
                box.classList.add('options-box')

                const optionInput = document.createElement('input');
                optionInput.type = 'radio';
                optionInput.name = `question${index + 1}`;
                optionInput.value = option

                const optionLabel = document.createElement('label');
                optionLabel.textContent = option;

                box.appendChild(optionInput)
                box.appendChild(optionLabel)
                box.appendChild(document.createElement('br'));

                optionsContainer.appendChild(box)
            });

            questionDiv.appendChild(questionTitle);
            questionDiv.appendChild(questionText);
            questionDiv.appendChild(optionsContainer);

            if (index > 0) {
                const prevButton = document.createElement('button');
                prevButton.id = `prev${index + 1}`;
                prevButton.textContent = 'Prev';
                prevButton.addEventListener('click', function () {
                    questionDiv.classList.remove('active');
                    currentQuestion--;
                    questionsContainer.children[currentQuestion].classList.add('active');
                });
                questionDiv.appendChild(prevButton);
            }

            if (index < TotalQuestion - 1) {
                const nextButton = document.createElement('button');
                nextButton.id = `next${index + 1}`;
                nextButton.textContent = 'Next';
                nextButton.addEventListener('click', function () {
                    questionDiv.classList.remove('active');
                    currentQuestion++;
                    questionsContainer.children[currentQuestion].classList.add('active');
                });
                questionDiv.appendChild(nextButton);
            }
            return questionDiv

        }

        const createSubmitButton = () => {
            const submitButton = document.createElement('button');
            submitButton.id = 'submit';
            submitButton.textContent = 'Submit';

            return submitButton

        }
        const createJumpSelect = () => {
            const JumpSelect = document.createElement('select');
            JumpSelect.id = 'JumpSelect';
            for (let x = 0; x < localStorage.getItem('TestLength'); x++) {

                const option = document.createElement('option')
                option.text = x +1 ;
                option.value = x;
                JumpSelect.add(option)
            }
            JumpSelect.addEventListener('change', function () {
                questionsContainer.children[currentQuestion].classList.remove('active');
                currentQuestion = JumpSelect.value
                questionsContainer.children[currentQuestion].classList.add('active');

            })

            return JumpSelect

        }


        const testlength = document.getElementById('testlength')
        testlength.innerHTML = `Test Lenght: ${localStorage.getItem('TestLength')}`


        const QuestionData = fetch(`/api/questions?testlength=${localStorage.getItem('TestLength')}`).then(response => response.json())

        QuestionData.then((data) => {
            TotalQuestion = data.data.length
            console.log(data.data)
            data.data.forEach((question, index) => {
                correctAnswers.push(question.ans)
                if (index + 1 <= TotalQuestion / 4) {
                    AnswerSheet['Verbal'][`question${index + 1}`] = question.ans;

                } else if (index + 1 > TotalQuestion / 4 && index + 1 <= ((TotalQuestion / 4) * 2)) {
                    AnswerSheet['GeneralAwareness'][`question${index + 1}`] = question.ans;

                } else if (index + 1 > ((TotalQuestion / 4) * 2) && index + 1 <= ((TotalQuestion / 4) * 3)) {
                    AnswerSheet['Aptitude'][`question${index + 1}`] = question.ans;

                } else {
                    AnswerSheet['Reasoning'][`question${index + 1}`] = question.ans;

                }
                const questionDiv = createQuestion(question, index, TotalQuestion)
                questionsContainer.appendChild(questionDiv);
            });
            const submitButton = createSubmitButton()
            const JumpSelect = createJumpSelect()

            submitButton.style.display = 'none'
            JumpSelect.style.display = 'none'
            questionsContainer.appendChild(JumpSelect);
            questionsContainer.appendChild(submitButton);

        });

        const startTest = () => {

            submited = false
            let totalSeconds = (localStorage.getItem('TestLength') * 0.6) *60;
            const minutesSpan = document.querySelector('#minutes');
            const secondsSpan = document.querySelector('#seconds');
            const submitbtn = document.getElementById('submit')
            const JumpSelect = document.getElementById('JumpSelect')
            testlength.style.display = 'none'
            submitbtn.style.display = 'block'
            JumpSelect.style.display = 'block'
            timer.style.display = 'block'
            const x = startCountdown(totalSeconds - 1, minutesSpan, secondsSpan, submitbtn)

            questionsContainer.children[0].classList.add('active');

            submitbtn.addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('TestLength')
                ResultDiv.style.display = 'block'
                clearInterval(x)
                minutesSpan.textContent = 0
                secondsSpan.textContent = 0

                questionsContainer.children[currentQuestion].classList.remove('active');
                submited = true
                displayResult()
                submitbtn.style.display = 'none'
                JumpSelect.style.display = 'none'
            });
        }

        const tac = document.getElementById('tac')
        const accept_tac = document.getElementById('accept_tac')
        accept_tac.addEventListener('click', () => {
            accept_tac.style.display = 'none'
            tac.style.display = 'none'
            startTest()

        });

        window.onbeforeunload = function () {
            return "Are you sure you want to leave this page?";
        };

        window.addEventListener("blur", function () {
            if (!submited) {
                submited = true
                questionsContainer.children[currentQuestion].classList.remove('active');
                timer.style.display = 'none'
                const img = document.createElement('img');
                img.setAttribute('id', 'kyabhai');
                img.setAttribute('src', '/fashya.jpeg');
                img.setAttribute('alt', 'image description');
                img.setAttribute('title', 'image title');

                document.body.appendChild(img);

                const sorrybtn = document.createElement('button')
                sorrybtn.id = 'sorrybtn';
                sorrybtn.textContent = 'Sorry!';
                document.body.appendChild(sorrybtn)

                const btn = document.getElementById('submit')
                const JumpSelect = document.getElementById('JumpSelect')
                btn.style.display = 'none'
                JumpSelect.style.display = 'none'
                sorrybtn.addEventListener('click', function () {

                    alert("Too Late!!!!")
                    img.remove()
                    sorrybtn.remove('sorrybtn')
                    btn.click()
                });
            }
        });
    </script>
</body>

</html>